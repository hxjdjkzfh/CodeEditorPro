name: Build Android App

# Add permissions needed for actions
permissions:
  contents: write
  packages: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-app:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Make all scripts executable
      run: |
        chmod +x *.sh
        chmod +x gradlew
        find . -name "gradlew" -exec chmod +x {} \;
        
    - name: Build Android APK (Full SDK method)
      run: |
        ./build_android.sh sdk
        
    - name: Verify APK
      run: |
        ls -lah code-editor.apk
        unzip -l code-editor.apk | grep classes.dex
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: code-editor-pro
        path: code-editor.apk
        
    - name: Send APK to Telegram
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        python3 send_to_telegram.py code-editor.apk --message "✅ Финальная версия APK Code Editor Pro! Полноценное мобильное приложение для Android с поддержкой всех языков программирования."
        
    - name: Create GitHub Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        name: Code Editor Pro - Latest Build
        tag_name: v1.0.${{ github.run_number }}
        files: |
          code-editor.apk
        body: |
          ## Code Editor Pro - Полная версия
          
          Полноценный Android-редактор кода с поддержкой множества языков программирования.
          
          ### Особенности:
          - Подсветка синтаксиса для множества языков
          - Интуитивный интерфейс с вкладками
          - Темная тема в стиле Windows 98 High Contrast
          - Автоматическое сохранение несохраненного кода
          - Панель с настройками и интерфейсом как в Notepad++
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
